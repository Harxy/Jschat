<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="/jquery/jquery.titlealert.js"></script>
    <script src="/faye.js"></script>
    <link rel='stylesheet' href='/style.css' />
    <title>chatjs</title>
  </head>
  <body>
    <div class='header'>
      <input type='text' id='name' placeholder='add your name' value='Anon' />
      <input type='text' id='input' placeholder='type and press enter' />
    </div>
    <div class='info'>
      <p> Please change your name above! </p>
      <p> <b> Welcome to chatjs </b> </p>
      <p> Join any room you like by adding '/rooms/[anything]' and see who's chatting there! Give that link to people to chat in that room </p>
      <p> <b> for now, let's chat in /rooms/devs. I'll remove this soon </b></p>
      <p> All html will work, and embedding in iframes and other fun stuff (although script tags have been disabled). Experiment! </p>
      <p> You can use 'gif me [keyword]' to create gifs (without the quotes) </p>
      <p> You can use 'dice me [diceType]' to roll dice! See the <a target="_blank" href='https://github.com/meadsteve/DiceApi'>readme</a> for more information on the type of dice you can use</p>
      <p> This is now fully open source! Please see our <a target="_blank" href='https://waffle.io/Harxy/Jschat/join'> waffleboard </a> to see how you can contribute. </p>
    </div>
    <div id='output'></div>
      <script>
        $(function() {
          var roomArray = window.location.pathname.split( '/' );
          roomName = roomArray[2];
          var client = new Faye.Client('/faye');
          $('#input').keyup(function(e){
            var message = $('#input').val();
            if (e.keyCode === 13 && message != null && message !='') {
              client.publish('/rooms/' + roomName, {
                text: message,
                name: $('#name').val()
              });

              $('#input').val('');
            }
          });
          client.subscribe('/rooms/' + roomName, function(message) {
             addToScreen(message.name, message.text);
            $.titleAlert("New!", {
              requireBlur:true,
              stopOnFocus:true,
              duration:15000,
              interval:700
            });
          });

          $.getJSON("/history/" + roomName, function (data) {
              // var items = [];
              $.each(data, function (key, val) {
                  addToScreen(data[key].data.name, data[key].data.text);
              });


          });

          $('#input').focus();
        });

       


          function addToScreen(name, message) {
              $('#output').prepend('<p>' + name + ': ' + message + '</p>');
          }
      </script>
  </body>
</html>
